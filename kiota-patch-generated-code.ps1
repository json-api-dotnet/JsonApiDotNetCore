<#
    Patches C# code generated by kiota.
    Workaround for bug at https://github.com/microsoft/kiota/issues/3944#issuecomment-2597201229.
#>
param (
    # Path to directory where kiota generated C# code.
    [Parameter(Mandatory=$true)]
    [string]$kiotaOutputDir
)

$osLineBreak = [System.Environment]::NewLine
$files = Get-ChildItem -Path $kiotaOutputDir -Recurse -Include *.cs

foreach ($file in $files)
{
    $content = Get-Content $file -Raw

    # add #nullable enable, suppress warning CS8625: Cannot convert null literal to non-nullable reference type.
    $content = ($content -replace '// <auto-generated/>', "// <auto-generated/>$osLineBreak#nullable enable$osLineBreak#pragma warning disable CS8625")

    # remove conditionals
    $content = ($content -replace "(?s)#if NETSTANDARD2_1_OR_GREATER .*?$osLineBreak#nullable enable$osLineBreak(?<ifBody>.*?)$osLineBreak#nullable restore$osLineBreak#else$osLineBreak(?<elseBody>.*?)$osLineBreak#endif", "`$1")

    # insert new line between member and next summary
    $content = ($content -replace "}$osLineBreak(?<indentedSummary>\s+/// <summary>)", "}$osLineBreak$osLineBreak`$1")

    Set-Content -Path $file -Value $content
}
