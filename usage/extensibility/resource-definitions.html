<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Resource Definitions </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Resource Definitions ">
      
      
      <link rel="icon" href="../../favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="../toc.html">
      
      
      
      
      <meta name="docfx:docurl" content="https://github.com/json-api-dotnet/JsonApiDotNetCore/blob/master/docs/usage/extensibility/resource-definitions.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

      <script async src="https://www.googletagmanager.com/gtag/js?id=G-78GTGF1FM2"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-78GTGF1FM2');
      </script>
  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../styles/img/favicon.png" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="resource-definitions">Resource Definitions</h1>

<p><em>since v2.3.4</em></p>
<p>Resource definitions provide a resource-oriented way to handle custom business logic (irrespective of the originating endpoint).
They are resolved from the dependency injection container, so you can inject dependencies in their constructor.</p>
<p>In v4.2 we introduced an extension method that you can use to register your resource definition.</p>
<pre><code class="lang-c#">// Program.cs
builder.Services.AddResourceDefinition&lt;ArticleDefinition&gt;();
</code></pre>
<div class="TIP">
<h5>Tip</h5>
<p>If you're using <a href="../resource-graph.html#auto-discovery">auto-discovery</a>, then resource services, repositories and resource definitions will be automatically registered for you.</p>
</div>
<div class="NOTE">
<h5>Note</h5>
<p>Prior to the introduction of auto-discovery (in v3), you needed to register the resource definition on the container yourself:</p>
<pre><code class="lang-c#">builder.Services.AddScoped&lt;ResourceDefinition&lt;Article, int&gt;, ArticleDefinition&gt;();
</code></pre>
</div>
<h2 id="customizing-queries">Customizing queries</h2>
<p><em>since v4.0</em></p>
<p>For various reasons (see examples below) you may need to change parts of the query, depending on resource type.
<code>JsonApiResourceDefinition&lt;TResource, TId&gt;</code> (which is an empty implementation of <code>IResourceDefinition&lt;TResource, TId&gt;</code>) provides overridable methods that pass you the result of query string parameter parsing.
The value returned by you determines what will be used to execute the query.</p>
<p>An intermediate format (<code>QueryExpression</code> and derived types) is used, which enables us to separate JSON:API implementation
from Entity Framework Core <code>IQueryable</code> execution.</p>
<h3 id="excluding-fields">Excluding fields</h3>
<p>There are some cases where you want attributes or relationships conditionally excluded from your resource response.
For example, you may accept some sensitive data that should only be exposed to administrators after creation.</p>
<div class="NOTE">
<h5>Note</h5>
<p>To exclude fields unconditionally, <a href="../resources/attributes.html#capabilities">attribute capabilities</a> and <a href="../resources/relationships.html#capabilities">relationship capabilities</a> can be used instead.</p>
</div>
<pre><code class="lang-c#">public class UserDefinition : JsonApiResourceDefinition&lt;User, int&gt;
{
    public UserDefinition(IResourceGraph resourceGraph)
        : base(resourceGraph)
    {
    }

    public override SparseFieldSetExpression OnApplySparseFieldSet(
        SparseFieldSetExpression existingSparseFieldSet)
    {
        if (IsAdministrator)
        {
            return existingSparseFieldSet;
        }

        return existingSparseFieldSet.Excluding&lt;User&gt;(
            user =&gt; user.Password, ResourceGraph);
    }
}
</code></pre>
<p>Using this technique, you can achieve the following request/response behavior:</p>
<pre><code class="lang-http">POST /users HTTP/1.1
Content-Type: application/vnd.api+json

{
  &quot;data&quot;: {
    &quot;type&quot;: &quot;users&quot;,
    &quot;attributes&quot;: {
      &quot;password&quot;: &quot;secret&quot;,
      &quot;name&quot;: &quot;John Doe&quot;
    }
  }
}
</code></pre>
<pre><code class="lang-http">HTTP/1.1 201 Created
Location: http://example.com/users/1
Content-Type: application/vnd.api+json

{
  &quot;data&quot;: {
    &quot;type&quot;: &quot;users&quot;,
    &quot;id&quot;: &quot;1&quot;,
    &quot;attributes&quot;: {
      &quot;name&quot;: &quot;John Doe&quot;
    }
  }
}
</code></pre>
<h3 id="default-sort-order">Default sort order</h3>
<p>You can define the default sort order if no <code>sort</code> query string parameter is provided.</p>
<pre><code class="lang-c#">public class AccountDefinition : JsonApiResourceDefinition&lt;Account, int&gt;
{
    public AccountDefinition(IResourceGraph resourceGraph)
        : base(resourceGraph)
    {
    }

    public override SortExpression OnApplySort(SortExpression existingSort)
    {
        if (existingSort != null)
        {
            return existingSort;
        }

        return CreateSortExpressionFromLambda(new PropertySortOrder
        {
            (account =&gt; account.Name, ListSortDirection.Ascending),
            (account =&gt; account.ModifiedAt, ListSortDirection.Descending)
        });
    }
}
</code></pre>
<h3 id="enforce-page-size">Enforce page size</h3>
<p>You may want to enforce pagination on large database tables.</p>
<pre><code class="lang-c#">public class AccessLogDefinition : JsonApiResourceDefinition&lt;AccessLog, int&gt;
{
    public AccessLogDefinition(IResourceGraph resourceGraph)
        : base(resourceGraph)
    {
    }

    public override PaginationExpression OnApplyPagination(
        PaginationExpression existingPagination)
    {
        var maxPageSize = new PageSize(10);

        if (existingPagination != null)
        {
            var pageSize = existingPagination.PageSize?.Value &lt;= maxPageSize.Value
                ? existingPagination.PageSize
                : maxPageSize;

            return new PaginationExpression(existingPagination.PageNumber, pageSize);
        }

        return new PaginationExpression(PageNumber.ValueOne, maxPageSize);
    }
}
</code></pre>
<h3 id="change-filters">Change filters</h3>
<p>The next example filters out <code>Account</code> resources that are suspended.</p>
<pre><code class="lang-c#">public class AccountDefinition : JsonApiResourceDefinition&lt;Account, int&gt;
{
    public AccountDefinition(IResourceGraph resourceGraph)
        : base(resourceGraph)
    {
    }

    public override FilterExpression OnApplyFilter(FilterExpression existingFilter)
    {
        var isSuspendedAttribute = ResourceType.Attributes.Single(account =&gt;
            account.Property.Name == nameof(Account.IsSuspended));

        var isNotSuspended = new ComparisonExpression(ComparisonOperator.Equals,
            new ResourceFieldChainExpression(isSuspendedAttribute),
            new LiteralConstantExpression(bool.FalseString));

        return existingFilter == null
            ? (FilterExpression) isNotSuspended
            : new LogicalExpression(LogicalOperator.And,
                new[] { isNotSuspended, existingFilter });
    }
}
</code></pre>
<h3 id="block-including-related-resources">Block including related resources</h3>
<p>In the example below, an error is returned when a user tries to include the manager of an employee.</p>
<pre><code class="lang-c#">public class EmployeeDefinition : JsonApiResourceDefinition&lt;Employee, int&gt;
{
    public EmployeeDefinition(IResourceGraph resourceGraph)
        : base(resourceGraph)
    {
    }

    public override IImmutableList&lt;IncludeElementExpression&gt; OnApplyIncludes(
        IImmutableList&lt;IncludeElementExpression&gt; existingIncludes)
    {
        if (existingIncludes.Any(include =&gt;
            include.Relationship.Property.Name == nameof(Employee.Manager)))
        {
            throw new JsonApiException(new ErrorObject(HttpStatusCode.BadRequest)
            {
                Title = &quot;Including the manager of employees is not permitted.&quot;
            });
        }

        return existingIncludes;
    }
}
</code></pre>
<h3 id="custom-query-string-parameters">Custom query string parameters</h3>
<p><em>since v3</em></p>
<p>You can define additional query string parameters with the LINQ expression that should be used.
If the key is present in a query string, the supplied LINQ expression will be added to the database query.</p>
<div class="NOTE">
<h5>Note</h5>
<p>This directly influences the Entity Framework Core <code>IQueryable</code>. As opposed to using <code>OnApplyFilter</code>, this enables the full range of Entity Framework Core operators.
But it only works on primary resource endpoints (for example: /articles, but not on /blogs/1/articles or /blogs?include=articles).</p>
</div>
<pre><code class="lang-c#">public class ItemDefinition : JsonApiResourceDefinition&lt;Item, int&gt;
{
    public ItemDefinition(IResourceGraph resourceGraph)
        : base(resourceGraph)
    {
    }

    public override QueryStringParameterHandlers&lt;Item&gt;
        OnRegisterQueryableHandlersForQueryStringParameters()
    {
        return new QueryStringParameterHandlers&lt;Item&gt;
        {
            [&quot;isActive&quot;] = (source, parameterValue) =&gt; source
                .Include(item =&gt; item.Children)
                .Where(item =&gt; item.LastUpdateTime &gt; DateTime.Now.AddMonths(-1)),
            [&quot;isHighRisk&quot;] = FilterByHighRisk
        };
    }

    private static IQueryable&lt;Item&gt; FilterByHighRisk(IQueryable&lt;Item&gt; source,
        StringValues parameterValue)
    {
        bool isFilterOnHighRisk = bool.Parse(parameterValue);

        return isFilterOnHighRisk
            ? source.Where(item =&gt; item.RiskLevel &gt;= 5)
            : source.Where(item =&gt; item.RiskLevel &lt; 5);
    }
}
</code></pre>
<h2 id="handling-resource-changes">Handling resource changes</h2>
<p><em>since v4.2</em></p>
<p>Without going into too much details, the diagrams below demonstrate a few scenarios where custom code interacts with write operations.
Click on a diagram to open it full-size in a new window.</p>
<h3 id="create-resource">Create resource</h3>
<a href="../../diagrams/resource-definition-create-resource.svg" target="_blank">
<img src="../../diagrams/resource-definition-create-resource.svg" style="border: 1px solid #000">
</a>
<ol>
<li>User sends request to create a resource</li>
<li>An empty resource instance is created</li>
<li>Developer sets default values for attribute 1 and 2</li>
<li>Attribute 1 and 3 from incoming request are copied into default instance</li>
<li>Developer overwrites attribute 3</li>
<li>Row is inserted in database</li>
<li>Developer sends notification to service bus</li>
<li>The new resource is fetched</li>
<li>Resource is sent back to the user</li>
</ol>
<h3 id="update-resource">Update Resource</h3>
<a href="../../diagrams/resource-definition-update-resource.svg" target="_blank">
<img src="../../diagrams/resource-definition-update-resource.svg" style="border: 1px solid #000">
</a>
<ol>
<li>User sends request to update resource with ID 1</li>
<li>Existing resource is fetched from database</li>
<li>Developer changes attribute 1 and 2</li>
<li>Attribute 1 and 3 from incoming request are copied into fetched instance</li>
<li>Developer overwrites attribute 3</li>
<li>Row is updated in database</li>
<li>Developer sends notification to service bus</li>
<li>The resource is fetched, along with requested includes</li>
<li>Resource with includes is sent back to the user</li>
</ol>
<h3 id="delete-resource">Delete Resource</h3>
<a href="../../diagrams/resource-definition-delete-resource.svg" target="_blank">
<img src="../../diagrams/resource-definition-delete-resource.svg" style="border: 1px solid #000">
</a>
<ol>
<li>User sends request to delete resource with ID 1</li>
<li>Developer runs custom validation logic</li>
<li>Row is deleted from database</li>
<li>Developer sends notification to service bus</li>
<li>Success status is sent back to user</li>
</ol>
<h3 id="set-relationship">Set Relationship</h3>
<a href="../../diagrams/resource-definition-set-relationship.svg" target="_blank">
<img src="../../diagrams/resource-definition-set-relationship.svg" style="border: 1px solid #000">
</a>
<ol>
<li>User sends request to assign two resources (green) to relationship 'name' (black) on resource 1 (yellow)</li>
<li>Existing resource (blue) with related resources (red) is fetched from database</li>
<li>Developer changes attributes (not shown in diagram for brevity)</li>
<li>Developer removes one resource from the to-be-assigned set (green)</li>
<li>Existing resources in relationship (red) are replaced with resource from previous step (green)</li>
<li>Developer overwrites attributes (not shown in diagram for brevity)</li>
<li>Resource and relationship are updated in database</li>
<li>Developer sends notification to service bus</li>
<li>Success status is sent back to user</li>
</ol>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/json-api-dotnet/JsonApiDotNetCore/blob/master/docs/usage/extensibility/resource-definitions.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>


    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
